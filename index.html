<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qu·∫£n L√Ω Ph∆∞·ªõc An - 2026</title>
    <style>
        :root { --blue: #1a73e8; --green: #34a853; --orange: #fbbc05; --red: #ea4335; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: #202124; }
        
        /* M√ÄN H√åNH CH√çNH */
        #home-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; gap: 20px; padding: 20px; box-sizing: border-box; }
        .btn-big { width: 100%; max-width: 350px; padding: 30px; border: none; border-radius: 20px; color: white; font-size: 1.3rem; font-weight: 800; cursor: pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.1); transition: 0.2s; }
        .btn-gv { background: var(--blue); }
        .btn-sd { background: var(--green); }
        .btn-bxh { background: var(--orange); }
        .btn-big:active { transform: scale(0.95); }

        /* CONTAINER CHUNG */
        .container { display: none; padding: 20px; max-width: 600px; margin: auto; }
        .card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .class-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .btn-cl { padding: 15px 5px; border: 1.5px solid #eee; border-radius: 12px; background: white; font-weight: bold; cursor: pointer; }
        .btn-cl:active { background: #e8f0fe; border-color: var(--blue); }

        /* DANH S√ÅCH L·ªñI */
        .item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #f1f3f4; cursor: pointer; border-radius: 10px; }
        .item.selected { background: #fff9c4; border-left: 5px solid var(--orange); }
        .inp-note { width: 100%; padding: 12px; margin-top: 10px; border: 1px solid #ddd; border-radius: 10px; display: none; box-sizing: border-box; }
        .item.selected + .inp-note { display: block; }

        /* BXH TR√åNH CHI·∫æU */
        #bxh-view { display: none; background: radial-gradient(circle, #1a237e, #000); min-height: 100vh; color: white; padding: 30px 15px; text-align: center; }
        .rank-row { display: flex; align-items: center; background: rgba(255,255,255,0.1); margin: 10px auto; padding: 15px 25px; border-radius: 15px; max-width: 800px; border: 1px solid rgba(255,255,255,0.1); }
        .rank-row:nth-child(1) { background: linear-gradient(90deg, #ffd700, #ff8f00); color: black; transform: scale(1.03); }
        .r-num { width: 50px; font-size: 1.8rem; font-weight: 900; }
        .r-name { flex: 1; text-align: left; font-size: 1.3rem; font-weight: bold; padding-left: 15px; }
        .r-pts { font-size: 1.8rem; font-weight: 900; }

        /* M√É PIN */
        #pin-screen { display: none; position: fixed; inset: 0; background: white; z-index: 999; flex-direction: column; align-items: center; justify-content: center; }
        .pin-input { font-size: 2.5rem; width: 160px; text-align: center; border: 2px solid #ddd; border-radius: 15px; padding: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="home-screen">
    <h2 style="margin-bottom: 10px;">THI ƒêUA PH∆Ø·ªöC AN</h2>
    <button class="btn-big btn-gv" onclick="openGV()">T√îI L√Ä GI√ÅO VI√äN</button>
    <button class="btn-big btn-sd" onclick="askPin('SD')">T√îI L√Ä SAO ƒê·ªé</button>
    <button class="btn-big btn-bxh" onclick="askPin('BXH')">BXH TR√åNH CHI·∫æU</button>
</div>

<div id="pin-screen">
    <h3 id="pin-label">NH·∫¨P M√É PIN</h3>
    <input type="password" class="pin-input" id="pin-box" maxlength="4" inputmode="numeric">
    <button class="btn-big btn-gv" style="width:160px" onclick="confirmPin()">V√ÄO</button>
    <p onclick="location.reload()" style="color:blue; margin-top:20px; cursor:pointer">Quay l·∫°i</p>
</div>

<div id="class-select" class="container">
    <h2 id="mode-title"></h2>
    <div class="class-grid" id="class-btns"></div>
</div>

<div id="input-screen" class="container">
    <h2 id="target-class" style="color:var(--blue)"></h2>
    <div id="criteria-list"></div>
    <button class="btn-big btn-gv" style="width:100%; margin-top:20px" onclick="sendData()">G·ª¨I D·ªÆ LI·ªÜU</button>
</div>

<div id="bxh-view">
    <h1 style="font-size: 2.5rem; text-shadow: 0 4px 10px rgba(0,0,0,0.5);">üèÜ B·∫¢NG V√ÄNG THI ƒêUA</h1>
    <div id="bxh-list"></div>
    <div style="margin-top: 30px;">
        <button class="btn-cl" onclick="location.reload()">THO√ÅT</button>
        <button class="btn-cl" style="background: var(--green); color:white; border:none" onclick="backupData()">SAO L∆ØU (CSV)</button>
    </div>
</div>

<script>
    const SCRIPT_URL = "D√ÅN_LINK_WEB_APP_URL_C·ª¶A_B·∫†N_·ªû_ƒê√ÇY";
    const PIN_SD = "1234", PIN_BXH = "9999";
    const LOP = ["6A1","6A2","6A3","7A1","7A2","7A3","8A1","8A2","9A1","9A2"];
    
    // PH√ÇN CHIA L·ªñI
    const LOI_SD = [
        {g:"T√°c phong", i:[{n:"Kh√¥ng khƒÉn qu√†ng",d:-5}, {n:"Sai ƒë·ªìng ph·ª•c",d:-5}, {n:"T√≥c nhu·ªôm/d√†i",d:-10}]},
        {g:"N·ªÅn n·∫øp", i:[{n:"ƒêi mu·ªôn",d:-2}, {n:"ƒÇn qu√† v·∫∑t",d:-5}, {n:"N√≥i t·ª•c",d:-10}]}
    ];
    const LOI_GV = [
        {g:"H·ªçc t·∫≠p", i:[{n:"Ti·∫øt h·ªçc lo·∫°i A",d:10}, {n:"Ti·∫øt h·ªçc lo·∫°i B",d:5}, {n:"Ti·∫øt h·ªçc lo·∫°i C",d:-5}, {n:"HS ph√°t bi·ªÉu",d:2}]}
    ];

    let currentRole = "", selectedClass = "", rawData = [];

    function askPin(role) {
        currentRole = role;
        document.getElementById('pin-screen').style.display = 'flex';
    }

    function confirmPin() {
        const pin = document.getElementById('pin-box').value;
        if (currentRole === 'SD' && pin === PIN_SD) showClassSelect();
        else if (currentRole === 'BXH' && pin === PIN_BXH) showBXH();
        else alert("M√£ PIN kh√¥ng ƒë√∫ng!");
    }

    function openGV() { currentRole = 'GV'; showClassSelect(); }

    function showClassSelect() {
        document.getElementById('home-screen').style.display = 'none';
        document.getElementById('pin-screen').style.display = 'none';
        document.getElementById('class-select').style.display = 'block';
        document.getElementById('mode-title').innerText = currentRole === 'GV' ? "GI√ÅO VI√äN: CH·ªåN L·ªöP" : "SAO ƒê·ªé: CH·ªåN L·ªöP";
        const grid = document.getElementById('class-btns');
        grid.innerHTML = "";
        LOP.forEach(l => grid.innerHTML += `<button class="btn-cl" onclick="startInput('${l}')">${l}</button>`);
    }

    function startInput(l) {
        selectedClass = l;
        document.getElementById('class-select').style.display = 'none';
        document.getElementById('input-screen').style.display = 'block';
        document.getElementById('target-class').innerText = "ƒêang ch·∫•m l·ªõp: " + l;
        const list = document.getElementById('criteria-list');
        list.innerHTML = "";
        const data = currentRole === 'GV' ? LOI_GV : LOI_SD;
        data.forEach(g => {
            list.innerHTML += `<div style="font-weight:bold; margin-top:15px; color:#666">${g.g}</div>`;
            g.i.forEach(item => {
                const id = Math.random().toString(36).substr(2, 5);
                list.innerHTML += `
                    <div class="item" id="it-${id}" onclick="this.classList.toggle('selected')">
                        <span>${item.n}</span><b>${item.d > 0 ? '+'+item.d : item.d}</b>
                        <input type="checkbox" style="display:none" data-n="${item.n}" data-d="${item.d}" data-g="${g.g}">
                    </div>
                    <input type="text" class="inp-note" id="note-${id}" placeholder="T√™n HS ho·∫∑c Ghi ch√∫...">`;
            });
        });
    }

    async function sendData() {
        const selected = document.querySelectorAll('.item.selected');
        if (!selected.length) return alert("B·∫°n ch∆∞a ch·ªçn m·ª•c n√†o!");
        
        for (let it of selected) {
            const id = it.id.replace('it-', '');
            const cb = it.querySelector('input');
            const note = document.getElementById('note-' + id).value || "T·∫≠p th·ªÉ";
            const payload = {
                lop: selectedClass,
                noiDung: cb.dataset.n,
                tenHS: note,
                diem: parseInt(cb.dataset.d),
                loai: (currentRole === 'GV' ? "SƒêB - " : "Sao ƒê·ªè - ") + cb.dataset.g
            };
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
        }
        alert("ƒê√£ l∆∞u d·ªØ li·ªáu th√†nh c√¥ng!");
        location.reload();
    }

    async function showBXH() {
        document.getElementById('home-screen').style.display = 'none';
        document.getElementById('pin-screen').style.display = 'none';
        document.getElementById('bxh-view').style.display = 'block';
        const list = document.getElementById('bxh-list');
        list.innerHTML = "ƒêang t·∫£i d·ªØ li·ªáu...";
        
        try {
            const res = await fetch(SCRIPT_URL);
            rawData = await res.json();
            let scores = {};
            LOP.forEach(l => scores[l] = 100);
            rawData.forEach(r => { if(scores[r[1]] !== undefined) scores[r[1]] += parseInt(r[4]); });
            
            const sorted = Object.keys(scores).sort((a,b) => scores[b] - scores[a]);
            list.innerHTML = "";
            sorted.forEach((l, i) => {
                list.innerHTML += `
                    <div class="rank-row">
                        <div class="r-num">${i+1}</div>
                        <div class="r-name">${l}</div>
                        <div class="r-pts">${scores[l]}</div>
                    </div>`;
            });
        } catch(e) { list.innerHTML = "L·ªói t·∫£i d·ªØ li·ªáu!"; }
    }

    function backupData() {
        let csv = "Th·ªùi gian,L·ªõp,N·ªôi dung,T√™n HS,ƒêi·ªÉm,Lo·∫°i\n";
        rawData.forEach(row => csv += row.join(",") + "\n");
        const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "SaoLuu_PhuocAn_" + new Date().toLocaleDateString() + ".csv";
        link.click();
    }
</script>
</body>
</html>
