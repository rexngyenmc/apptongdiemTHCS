<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T·ªîNG ƒêI·ªÇM TH&THCS Ph∆∞·ªõc An</title>
    <style>
        :root { --p: #0056b3; --s: #2e7d32; --a: #d32f2f; --bg: #f4f7f6; --gold: #ffd700; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); margin: 0; padding: 10px; padding-bottom: 80px; color: #333; }
        
        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--p); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; color: white; }
        .pin-input { width: 150px; padding: 15px; border-radius: 12px; border: none; font-size: 2rem; text-align: center; letter-spacing: 5px; font-weight: bold; margin: 20px 0; color: var(--p); }

        #main-content { display: none; max-width: 1200px; margin: 0 auto; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* HEADER */
        .header { background: white; padding: 15px; border-radius: 15px; text-align: center; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-bottom: 4px solid var(--p); }
        .school-title { font-size: 1.1rem; font-weight: bold; color: var(--p); text-transform: uppercase; }

        .container { display: flex; flex-wrap: wrap; gap: 15px; }

        /* B·∫¢NG X·∫æP H·∫†NG */
        .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); flex: 1; min-width: 300px; }
        table { width: 100%; border-collapse: collapse; }
        td { padding: 10px 5px; text-align: center; border-bottom: 1px solid #f9f9f9; font-weight: bold; font-size: 0.9rem; }
        
        .rank { width: 28px; height: 28px; line-height: 28px; display: inline-block; border-radius: 50%; background: #eee; font-size: 0.75rem; }
        .rank-1 { background: var(--gold); }
        .rank-2 { background: #e0e0e0; }
        .rank-3 { background: #f0d0b0; }

        .lop-row { cursor: pointer; transition: 0.2s; }
        .dang-chon { background: #e3f2fd !important; outline: 2px solid var(--p); }

        /* √î NH·∫¨P T√äN TR√äN C√ôNG */
        .sticky-input { position: sticky; top: 0; background: white; z-index: 20; padding: 10px 0; border-bottom: 2px solid #eee; margin-bottom: 10px; }
        .name-input { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid var(--p); font-size: 1rem; box-sizing: border-box; outline: none; }

        /* B·∫¢NG L·ªñI C≈® (D·∫†NG TICK) */
        .scroll-form { max-height: 400px; overflow-y: auto; padding-right: 5px; }
        .group-title { background: #f8f9fa; color: var(--p); padding: 8px; font-weight: bold; margin-top: 15px; font-size: 0.75rem; border-radius: 5px; border-left: 4px solid var(--p); }
        .loi-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f1f1; cursor: pointer; }
        .loi-item:hover { background: #fdfdfd; }
        .loi-item span { flex: 1; font-size: 0.85rem; color: #333; margin-left: 10px; }
        .score-tag { width: 50px; font-weight: bold; font-size: 0.8rem; text-align: right; margin-right: 5px; }
        .minus { color: var(--a); }
        .plus { color: var(--s); }
        
        .ck-box { width: 20px; height: 20px; cursor: pointer; }

        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-apply { background: var(--p); color: white; }
        .btn-zalo { background: #0068ff; color: white; }
        .btn-reset { background: #fff; color: var(--a); border: 1px solid var(--a); margin-top: 20px; font-size: 0.7rem; }

        .history-box { margin-top: 15px; font-size: 0.75rem; background: #f9f9f9; padding: 10px; border-radius: 10px; border-left: 4px solid #fbc02d; }
    </style>
</head>
<body>

<div id="login-screen">
    <h2>üîë SAO ƒê·ªé PH∆Ø·ªöC AN</h2>
    <input type="password" id="pin-input" class="pin-input" placeholder="****" maxlength="4" oninput="checkPin()">
</div>

<div id="main-content">
    <div class="header">
        <div class="school-title">Tr∆∞·ªùng TH & THCS Ph∆∞·ªõc An</div>
        <p style="margin:5px 0 0 0; font-size:0.8rem; color:#555;">CH·∫§M ƒêI·ªÇM: NH·∫¨P T√äN -> TICK L·ªñI -> L∆ØU</p>
    </div>

    <div class="container">
        <div class="card" style="flex: 1;">
            <h3>üèÜ B·∫£ng X·∫øp H·∫°ng</h3>
            <table>
                <thead><tr><th>XH</th><th>L·ªõp</th><th>ƒêi·ªÉm</th></tr></thead>
                <tbody id="body-bang">
                    <script>
                        const lops = ['6A','6B','6C','7A','7B','7C','8A','8B','8C','9A','9B'];
                        lops.forEach(l => {
                          document.write(`<tr class="lop-row" data-lop="${l}" data-tong="100" onclick="chonLop(this)"><td class="rank-cell"></td><td>L·ªõp ${l}</td><td class="tong">100</td></tr>`);
                        });
                    </script>
                </tbody>
            </table>
            <button class="btn btn-zalo" onclick="xuatZalo()">üîµ Xu·∫•t B√°o C√°o Zalo</button>
            <button class="btn btn-reset" onclick="resetDuLieu()">üîÑ Reset Tu·∫ßn M·ªõi</button>
        </div>

        <div id="panel" class="card" style="display:none; flex: 1.6;">
            <div class="sticky-input">
                <h3 id="tenlop" style="margin:0 0 10px 0; color:var(--p)">Ch·ªçn L·ªõp</h3>
                <input type="text" id="input-names" class="name-input" placeholder="Nh·∫≠p t√™n HS vi ph·∫°m: Ho√†ng, √Çn, H√†..." oninput="reCalc()">
            </div>
            
            <div class="scroll-form" id="form-loi">
                <div class="group-title">T√ÅC PHONG & ƒê·∫†O ƒê·ª®C</div>
                <div class="loi-item" onclick="toggleCk('m1')">
                    <input type="checkbox" class="ck-box" id="m1" data-n="KhƒÉn qu√†ng" data-d="-5" onchange="reCalc()">
                    <span>Kh√¥ng ƒëeo KhƒÉn qu√†ng/Huy hi·ªáu</span><b class="score-tag minus">-5</b>
                </div>
                <div class="loi-item" onclick="toggleCk('m2')">
                    <input type="checkbox" class="ck-box" id="m2" data-n="T√°c phong" data-d="-5" onchange="reCalc()">
                    <span>Kh√¥ng b·ªè √°o v√†o qu·∫ßn</span><b class="score-tag minus">-5</b>
                </div>
                <div class="loi-item" onclick="toggleCk('m12')">
                    <input type="checkbox" class="ck-box" id="m12" data-n="N√≥i t·ª•c" data-d="-10" onchange="reCalc()">
                    <span>N√≥i t·ª•c, ch·ª≠i th·ªÅ</span><b class="score-tag minus">-10</b>
                </div>

                <div class="group-title">CHUY√äN C·∫¶N & TR·∫¨T T·ª∞</div>
                <div class="loi-item" onclick="toggleCk('m15')">
                    <input type="checkbox" class="ck-box" id="m15" data-n="ƒêi tr·ªÖ" data-d="-2" onchange="reCalc()">
                    <span>ƒêi h·ªçc tr·ªÖ</span><b class="score-tag minus">-2</b>
                </div>
                <div class="loi-item" onclick="toggleCk('m18')">
                    <input type="checkbox" class="ck-box" id="m18" data-n="N√≥i chuy·ªán" data-d="-5" onchange="reCalc()">
                    <span>N√≥i chuy·ªán ri√™ng</span><b class="score-tag minus">-5</b>
                </div>

                <div class="group-title">H·ªåC T·∫¨P & ƒêI·ªÇM S·ªê</div>
                <div class="loi-item" onclick="toggleCk('m39')">
                    <input type="checkbox" class="ck-box" id="m39" data-n="ƒêi·ªÉm 10" data-d="10" onchange="reCalc()">
                    <span>ƒê·∫°t ƒëi·ªÉm 10</span><b class="score-tag plus">+10</b>
                </div>
                <div class="loi-item" onclick="toggleCk('m44')">
                    <input type="checkbox" class="ck-box" id="m44" data-n="C·ªßa r∆°i" data-d="5" onchange="reCalc()">
                    <span>Nh·∫∑t c·ªßa r∆°i tr·∫£ l·∫°i</span><b class="score-tag plus">+5</b>
                </div>
                </div>
            
            <button class="btn btn-apply" onclick="luuDiem()">L∆ØU ƒêI·ªÇM & NH·∫¨T K√ù</button>
            <div class="history-box" id="log-box">Nh·∫≠t k√Ω: Ch∆∞a c√≥ d·ªØ li·ªáu.</div>
        </div>
    </div>
</div>

<script>
const PIN = "1234";	
let db = JSON.parse(localStorage.getItem('pa_v9_data')) || {};

function checkPin() {
    if (document.getElementById("pin-input").value === PIN) {
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("main-content").style.display = "block";
        renderTable();
    }
}

function toggleCk(id) {
    const ck = document.getElementById(id);
    ck.checked = !ck.checked;
    reCalc();
}

// T·ª± ƒë·ªông t√≠nh ƒëi·ªÉm t·∫°m th·ªùi khi g√µ t√™n ho·∫∑c tick
function reCalc() {
    const names = document.getElementById('input-names').value.split(/[,.;]+/).filter(t => t.trim() !== "");
    const count = names.length;
    let tamTinh = 0;
    
    document.querySelectorAll('.ck-box:checked').forEach(ck => {
        tamTinh += (count * parseInt(ck.dataset.d));
    });
    
    const displayScore = 100 + tamTinh;
    document.getElementById('tenlop').innerHTML = `L·ªõp ${currentLop} <span style="color:${tamTinh < 0 ? 'red':'green'}">(${displayScore}ƒë)</span>`;
}

let currentLop = "";
function chonLop(row) {
    document.querySelectorAll(".lop-row").forEach(r => r.classList.remove("dang-chon"));
    row.classList.add("dang-chon");
    document.getElementById("panel").style.display = "block";
    
    currentLop = row.dataset.lop;
    
    // T·∫£i d·ªØ li·ªáu c≈© ƒë·ªÉ ƒêI·ªÄU CH·ªàNH
    const data = db[currentLop] || { names: "", checks: [] };
    document.getElementById('input-names').value = data.names;
    
    document.querySelectorAll('.ck-box').forEach(ck => {
        ck.checked = data.checks.includes(ck.id);
    });
    
    reCalc();
    renderLog();
}

function luuDiem() {
    const nameStr = document.getElementById('input-names').value;
    const names = nameStr.split(/[,.;]+/).filter(t => t.trim() !== "");
    const count = names.length;
    const checks = Array.from(document.querySelectorAll('.ck-box:checked')).map(ck => ck.id);
    
    let hieuSo = 0;
    let desc = [];
    document.querySelectorAll('.ck-box:checked').forEach(ck => {
        hieuSo += (count * parseInt(ck.dataset.d));
        desc.push(`${ck.dataset.n}(${count})`);
    });

    const gio = new Date().toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'});
    
    db[currentLop] = {
        names: nameStr,
        checks: checks,
        total: 100 + hieuSo,
        logText: `[${gio}] ${desc.join(", ") || "C·∫≠p nh·∫≠t"}: ${nameStr}`
    };

    localStorage.setItem('pa_v9_data', JSON.stringify(db));
    renderTable();
    renderLog();
    alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
}

function renderTable() {
    lops.forEach(l => {
        let r = document.querySelector(`.lop-row[data-lop="${l}"]`);
        let score = db[l] ? db[l].total : 100;
        r.querySelector(".tong").innerText = score;
        r.dataset.tong = score;
    });
    xepHang();
}

function xepHang() {
    let rows = Array.from(document.querySelectorAll(".lop-row"));
    rows.sort((a,b) => Number(b.dataset.tong) - Number(a.dataset.tong));
    let container = document.getElementById("body-bang");
    rows.forEach((r, i) => {
        let h = i + 1;
        r.querySelector(".rank-cell").innerHTML = `<span class="rank ${h<=3?'rank-'+h:''}">${h==1?'ü•á':h==2?'ü•à':h==3?'ü•â':h}</span>`;
        container.appendChild(r);
    });
}

function renderLog() {
    const box = document.getElementById("log-box");
    box.innerHTML = db[currentLop] ? `Nh·∫≠t k√Ω: ${db[currentLop].logText}` : "Nh·∫≠t k√Ω: Ch∆∞a c√≥ d·ªØ li·ªáu.";
}

function xuatZalo() {
    let msg = "üìä THI ƒêUA PH∆Ø·ªöC AN\n";
    let rows = Array.from(document.querySelectorAll(".lop-row"));
    rows.sort((a,b) => Number(b.dataset.tong) - Number(a.dataset.tong));
    rows.forEach((r, i) => {
        msg += `${i+1}. L·ªõp ${r.dataset.lop}: ${r.dataset.tong}ƒë\n`;
    });
    navigator.clipboard.writeText(msg).then(() => alert("ƒê√£ copy b√°o c√°o!"));
}

function resetDuLieu() {
    if(confirm("X√≥a to√†n b·ªô ƒëi·ªÉm tu·∫ßn n√†y?")) {
        localStorage.clear(); location.reload();
    }
}
</script>
</body>
</html>
