<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªÜ TH·ªêNG QU·∫¢N L√ù THI ƒêUA PH∆Ø·ªöC AN</title>
    <style>
        :root { --p: #0056b3; --s: #2e7d32; --a: #d32f2f; --bg: #f4f7f9; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); margin: 0; padding: 0; }
        .navbar { background: var(--p); display: flex; justify-content: space-around; padding: 12px 0; position: sticky; top: 0; z-index: 1000; }
        .nav-item { color: white; text-decoration: none; font-weight: bold; font-size: 0.9rem; cursor: pointer; padding: 5px 15px; border-radius: 20px; }
        .nav-item.active { background: white; color: var(--p); }
        
        #login-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; }
        .pin-box { background: white; padding: 25px; border-radius: 15px; color: #333; text-align: center; width: 85%; max-width: 320px; }
        
        .container { padding: 15px; max-width: 650px; margin: auto; }
        .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }
        
        /* B·∫£ng x·∫øp h·∫°ng */
        .rank-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .rank-table th { background: #eee; padding: 10px; font-size: 0.8rem; }
        .rank-table td { border: 1px solid #ddd; padding: 10px; text-align: center; font-weight: bold; }
        .top1 { background: #ffd700; }

        .class-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .class-btn { background: white; border: 2px solid var(--p); padding: 15px 5px; border-radius: 10px; font-weight: bold; color: var(--p); cursor: pointer; text-align: center; }

        .scroll-list { max-height: 350px; overflow-y: auto; border: 1px solid #ddd; border-radius: 10px; margin: 10px 0; }
        .group-title { background: #f8f9fa; padding: 8px; font-weight: bold; font-size: 0.75rem; border-left: 4px solid var(--p); position: sticky; top: 0; z-index: 10; border-bottom: 1px solid #ddd; }
        
        .loi-item { display: flex; flex-direction: column; padding: 12px; border-bottom: 1px solid #eee; }
        .loi-row { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .input-name { width: 100%; margin-top: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; display: none; box-sizing: border-box; font-size: 0.9rem; }
        .loi-item.active { background: #eef6ff; }
        .loi-item.active .input-name { display: block; border-color: var(--p); }

        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-save { background: var(--p); color: white; }
        .btn-summary { background: #ff9800; color: white; font-size: 1.1rem; border: 2px solid #e68a00; }
        
        .minus { color: var(--a); } .plus { color: var(--s); }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="pin-box">
        <h3 id="login-title">X√ÅC NH·∫¨N M√É PIN</h3>
        <input type="password" id="pin-input" style="width:100%; padding:12px; font-size:1.8rem; text-align:center; margin:15px 0; border-radius:8px; border:1px solid #ccc;" maxlength="4" inputmode="numeric">
        <button class="btn btn-save" onclick="verifyPin()">ƒêƒÇNG NH·∫¨P</button>
        <button class="btn" style="background:#f1f1f1" onclick="closeLogin()">H·ª¶Y</button>
    </div>
</div>

<nav class="navbar">
    <div class="nav-item active" id="m-saodo" onclick="switchTab('saodo')">S·ªî SAO ƒê·ªé</div>
    <div class="nav-item" id="m-daubai" onclick="switchTab('daubai')">S·ªî ƒê·∫¶U B√ÄI</div>
</nav>

<div class="container">
    <div id="tab-saodo">
        <div class="card">
            <h2 style="margin:0 0 10px 0; font-size:1.1rem; text-align:center; color:var(--p)">B·∫¢NG T·ªîNG S·∫ÆP THI ƒêUA</h2>
            <button class="btn btn-summary" onclick="tongKetTuan()">‚ö° T·ªîNG K·∫æT & X·∫æP H·∫†NG TU·∫¶N</button>
            <table class="rank-table">
                <thead><tr><th>H·∫°ng</th><th>L·ªõp</th><th>T·ªïng ƒêi·ªÉm</th></tr></thead>
                <tbody id="bxh-body"></tbody>
            </table>
            <button class="btn btn-save" onclick="openLogin('SAODO')" style="margin-top:20px">üîë ƒêƒÇNG NH·∫¨P SAO ƒê·ªé</button>
        </div>

        <div id="saodo-panel" class="card" style="display:none">
            <h3 id="sd-label" style="color:var(--p); text-align:center"></h3>
            <div id="list-sd" class="scroll-list"></div>
            <button class="btn btn-save" onclick="saveData('sd')">üíæ L∆ØU ƒêI·ªÇM SAO ƒê·ªé</button>
        </div>
    </div>

    <div id="tab-daubai" style="display:none">
        <div class="card" id="db-select">
            <h3 style="text-align:center">CH·ªåN L·ªöP ƒê·ªÇ GHI S·ªî</h3>
            <div class="class-grid" id="class-grid-list"></div>
        </div>

        <div id="daubai-panel" class="card" style="display:none">
            <h3 id="db-label" style="color:var(--s); text-align:center"></h3>
            <div id="list-db" class="scroll-list"></div>
            <button class="btn btn-save" onclick="saveData('db')" style="background:var(--s)">üíæ GHI V√ÄO S·ªî ƒê·∫¶U B√ÄI</button>
            <button class="btn" onclick="exitClass()" style="background:#666; color:white">QUAY L·∫†I</button>
        </div>
    </div>

    <div class="card" id="history-card" style="display:none">
        <h3>üìú CHI TI·∫æT ƒê√É GHI: <span id="active-class-name"></span></h3>
        <div style="overflow-x:auto">
            <table class="rank-table">
                <thead><tr><th>N·ªôi dung</th><th>T√™n HS</th><th>ƒêi·ªÉm</th><th>X√≥a</th></tr></thead>
                <tbody id="log-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const LOP_LIST = ["6A", "6B", "6C", "7A", "7B", "7C", "8A", "8B", "8C", "9A", "9B"];
    const PIN_SAODO = "1234";
    const PIN_LOP = "2025";

    // Danh m·ª•c ƒë·∫ßy ƒë·ªß l·ªói theo File Word
    const CRITERIA = [
        { g: "X·∫æP LO·∫†I TI·∫æT H·ªåC", i: [{n:"Ti·∫øt h·ªçc lo·∫°i A",d:10}, {n:"Ti·∫øt h·ªçc lo·∫°i B",d:5}, {n:"Ti·∫øt h·ªçc lo·∫°i C",d:-5}, {n:"Ti·∫øt h·ªçc lo·∫°i D",d:-10}] },
        { g: "T√ÅC PHONG", i: [{n:"Kh√¥ng khƒÉn qu√†ng/huy hi·ªáu",d:-5}, {n:"Kh√¥ng s∆° vin",d:-5}, {n:"M·∫∑c √°o kho√°c",d:-5}, {n:"T√≥c d√†i (Nam)",d:-5}] },
        { g: "K·ª∂ LU·∫¨T", i: [{n:"N√≥i t·ª•c ch·ª≠i th·ªÅ",d:-10}, {n:"ƒê√°nh nhau",d:-10}, {n:"B·ªè r√°c sai ch·ªó",d:-20}, {n:"Chui r√†o",d:-30}] },
        { g: "H·ªåC T·∫¨P", i: [{n:"ƒêi·ªÉm 10",d:10}, {n:"ƒêi·ªÉm 8,9",d:9}, {n:"ƒêi·ªÉm 0-3",d:-10}, {n:"Kh√¥ng b√†i t·∫≠p",d:-10}] }
    ];

    let db = JSON.parse(localStorage.getItem('PHUOC_AN_DATA')) || {};
    let activeClass = "";
    let loginType = "";

    function init() {
        LOP_LIST.forEach(l => { if(!db[l]) db[l] = { score: 100, logs: [] }; });
        renderBXH();
        const grid = document.getElementById('class-grid-list');
        LOP_LIST.forEach(l => grid.innerHTML += `<div class="class-btn" onclick="openLogin('LOP', '${l}')">${l}</div>`);
        buildCriteria('sd');
        buildCriteria('db');
    }

    function buildCriteria(type) {
        const container = document.getElementById('list-' + type);
        CRITERIA.forEach(group => {
            container.innerHTML += `<div class="group-title">${group.g}</div>`;
            group.i.forEach(item => {
                const id = type + Math.random().toString(36).substr(2, 5);
                container.innerHTML += `
                    <div class="loi-item" id="item-${id}">
                        <div class="loi-row" onclick="toggleItem('${id}')">
                            <span style="flex:1">${item.n}</span>
                            <span class="${item.d<0?'minus':'plus'}"><b>${item.d>0?'+':''}${item.d}</b></span>
                            <input type="checkbox" id="cb-${id}" data-n="${item.n}" data-d="${item.d}" style="display:none">
                        </div>
                        <input type="text" class="input-name" id="name-${id}" placeholder="Nh·∫≠p t√™n HS ho·∫∑c ghi 'C·∫£ l·ªõp'...">
                    </div>`;
            });
        });
    }

    function tongKetTuan() {
        if(!confirm("H·ªá th·ªëng s·∫Ω t√≠nh to√°n l·∫°i to√†n b·ªô ƒëi·ªÉm v√† x·∫øp h·∫°ng. Ti·∫øp t·ª•c?")) return;
        renderBXH();
        alert("ƒê√£ c·∫≠p nh·∫≠t b·∫£ng x·∫øp h·∫°ng m·ªõi nh·∫•t!");
    }

    function renderBXH() {
        // S·∫Øp x·∫øp l·ªõp theo ƒëi·ªÉm t·ª´ cao xu·ªëng th·∫•p
        const sorted = [...LOP_LIST].sort((a,b) => db[b].score - db[a].score);
        const body = document.getElementById('bxh-body');
        body.innerHTML = "";
        sorted.forEach((l, i) => {
            const isTop = i === 0 ? "top1" : "";
            body.innerHTML += `<tr class="${isTop}" onclick="selectClassSD('${l}')">
                <td>${i+1}</td>
                <td>L·ªõp ${l}</td>
                <td>${db[l].score}</td>
            </tr>`;
        });
    }

    function saveData(type) {
        const selected = document.querySelectorAll(`#list-${type} input[type="checkbox"]:checked`);
        if (selected.length === 0) return alert("B·∫°n ch∆∞a ch·ªçn m·ª•c n√†o!");

        selected.forEach(cb => {
            const id = cb.id.replace('cb-', '');
            const name = document.getElementById('name-'+id).value || "T·∫≠p th·ªÉ";
            const points = parseInt(cb.dataset.d);
            
            // X·ª≠ l√Ω x2, x3 trong t√™n
            let times = 1;
            const match = name.match(/x(\d+)/);
            if(match) times = parseInt(match[1]);

            db[activeClass].logs.unshift({
                id: Date.now() + Math.random(),
                content: cb.dataset.n + (type === 'sd' ? ' (SD)' : ' (SƒêB)'),
                total: points * times,
                who: name
            });
            db[activeClass].score += (points * times);
            
            // Reset form
            cb.checked = false;
            document.getElementById('item-'+id).classList.remove('active');
            document.getElementById('name-'+id).value = "";
        });

        localStorage.setItem('PHUOC_AN_DATA', JSON.stringify(db));
        renderLogs();
        alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
    }

    function renderLogs() {
        const body = document.getElementById('log-body');
        body.innerHTML = "";
        document.getElementById('active-class-name').innerText = activeClass;
        db[activeClass].logs.forEach(log => {
            body.innerHTML += `<tr>
                <td style="text-align:left; font-size:0.75rem">${log.content}</td>
                <td>${log.who}</td>
                <td class="${log.total<0?'minus':'plus'}">${log.total}</td>
                <td><button onclick="deleteLog(${log.id})" style="border:none; background:none; color:red">‚úï</button></td>
            </tr>`;
        });
    }

    function openLogin(type, lop = "") {
        loginType = type;
        activeClass = lop;
        document.getElementById('login-title').innerText = type === "SAODO" ? "M√É PIN SAO ƒê·ªé" : "M√É PIN L·ªöP " + lop;
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('pin-input').focus();
    }

    function verifyPin() {
        const pin = document.getElementById('pin-input').value;
        if ((loginType === "SAODO" && pin === PIN_SAODO) || (loginType === "LOP" && pin === PIN_LOP)) {
            document.getElementById('login-screen').style.display = 'none';
            if (loginType === "LOP") {
                document.getElementById('db-select').style.display = 'none';
                document.getElementById('daubai-panel').style.display = 'block';
                document.getElementById('history-card').style.display = 'block';
                document.getElementById('db-label').innerText = "S·ªî ƒê·∫¶U B√ÄI " + activeClass;
                renderLogs();
            } else {
                alert("ƒê√£ x√°c th·ª±c Sao ƒê·ªè. Ch·ªçn l·ªõp d∆∞·ªõi b·∫£ng x·∫øp h·∫°ng ƒë·ªÉ ch·∫•m.");
            }
        } else { alert("M√£ PIN kh√¥ng ch√≠nh x√°c!"); }
        document.getElementById('pin-input').value = "";
    }

    function selectClassSD(lop) {
        if(loginType !== "SAODO") return;
        activeClass = lop;
        document.getElementById('saodo-panel').style.display = 'block';
        document.getElementById('history-card').style.display = 'block';
        document.getElementById('sd-label').innerText = "SAO ƒê·ªé CH·∫§M: " + lop;
        renderLogs();
    }

    function deleteLog(id) {
        if(!confirm("X√≥a m·ª•c n√†y?")) return;
        const idx = db[activeClass].logs.findIndex(l => l.id === id);
        db[activeClass].score -= db[activeClass].logs[idx].total;
        db[activeClass].logs.splice(idx, 1);
        localStorage.setItem('PHUOC_AN_DATA', JSON.stringify(db));
        renderLogs(); renderBXH();
    }

    function switchTab(tab) {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById('m-'+tab).classList.add('active');
        document.getElementById('tab-saodo').style.display = tab === 'saodo' ? 'block' : 'none';
        document.getElementById('tab-daubai').style.display = tab === 'daubai' ? 'block' : 'none';
        document.getElementById('history-card').style.display = 'none';
    }

    function toggleItem(id) {
        const cb = document.getElementById('cb-'+id);
        const item = document.getElementById('item-'+id);
        cb.checked = !cb.checked;
        item.classList.toggle('active', cb.checked);
        if(cb.checked) document.getElementById('name-'+id).focus();
    }

    function closeLogin() { document.getElementById('login-screen').style.display = 'none'; }
    function exitClass() { location.reload(); }

    init();
</script>
</body>
</html>
