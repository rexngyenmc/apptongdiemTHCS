<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QUáº¢N LÃ THI ÄUA PHÆ¯á»šC AN</title>
    <style>
        :root { --p: #0056b3; --s: #2e7d32; --a: #d32f2f; --bg: #f4f7f9; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; }
        
        /* Menu Navigation */
        .navbar { background: var(--p); display: flex; justify-content: space-around; padding: 10px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .nav-item { color: white; text-decoration: none; font-weight: bold; font-size: 0.9rem; padding: 8px 15px; border-radius: 20px; transition: 0.3s; cursor: pointer; }
        .nav-item.active { background: white; color: var(--p); }

        /* Login Overlay */
        #login-screen { position: fixed; inset: 0; background: var(--p); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; text-align: center; }
        .pin-input { width: 160px; padding: 15px; border-radius: 15px; border: none; font-size: 2rem; text-align: center; margin: 20px 0; outline: none; }

        .container { padding: 15px; max-width: 600px; margin: auto; }
        .header { background: white; padding: 15px; border-radius: 15px; text-align: center; margin-bottom: 15px; border-top: 5px solid var(--p); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }

        /* Form Styles */
        .loi-item { display: flex; flex-direction: column; padding: 12px; border-bottom: 1px solid #eee; }
        .loi-row { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .input-name { width: 100%; margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; display: none; box-sizing: border-box; }
        .loi-item.active { background: #f0f7ff; }
        .loi-item.active .input-name { display: block; }
        
        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1rem; }
        .btn-save { background: var(--p); color: white; }
        .btn-copy { background: var(--s); color: white; }
        .btn-logout { background: #666 !important; color: white; margin-top: 20px; font-size: 0.8rem; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        th, td { border: 1px solid #ddd; padding: 10px 5px; text-align: center; }
        th { background: #f8f9fa; }
        .minus { color: var(--a); } .plus { color: var(--s); }
        .rank { width: 25px; height: 25px; line-height: 25px; display: inline-block; border-radius: 50%; background: #eee; font-size: 0.7rem; }
        .active-lop { background: #e3f2fd !important; border: 1px solid var(--p); }
    </style>
</head>
<body>

<div id="login-screen">
    <h2 style="margin:0">Há»† THá»NG PHÆ¯á»šC AN</h2>
    <p>Vui lÃ²ng nháº­p mÃ£ PIN (Sao Ä‘á» hoáº·c Lá»›p)</p>
    <input type="password" id="pin-input" class="pin-input" placeholder="****" maxlength="4" oninput="handleAuth()">
    <p id="login-msg" style="color: #ffeb3b;"></p>
</div>

<nav class="navbar" id="main-nav" style="display:none">
    <div class="nav-item active" id="menu-saodo" onclick="switchTab('saodo')">Sá»” SAO Äá»</div>
    <div class="nav-item" id="menu-daubai" onclick="switchTab('daubai')">Sá»” Äáº¦U BÃ€I</div>
</nav>

<div class="container" id="app" style="display:none">
    
    <div id="tab-saodo">
        <div class="header">
            <h2 style="margin:0; font-size: 1.1rem; color:var(--p)">Báº¢NG THI ÄUA TOÃ€N TRÆ¯á»œNG</h2>
        </div>
        <div class="card">
            <h3>ğŸ† Xáº¾P Háº NG TUáº¦N</h3>
            <table id="bxh-table">
                <thead><tr><th>Háº¡ng</th><th>Lá»›p</th><th>Äiá»ƒm</th></tr></thead>
                <tbody id="bxh-body"></tbody>
            </table>
        </div>
        <div id="saodo-input-area" class="card" style="display:none">
            <h3 id="saodo-lop-label" style="text-align:center; color:var(--p)"></h3>
            <input type="text" id="search-saodo" class="input-name" style="display:block; margin-bottom:10px" placeholder="ğŸ” TÃ¬m lá»—i..." onkeyup="filterLoi('saodo')">
            <div id="list-saodo" style="max-height:300px; overflow-y:auto; border:1px solid #ddd; border-radius:10px"></div>
            <button class="btn btn-save" onclick="saveData('saodo')">ğŸ’¾ LÆ¯U Dá»® LIá»†U SAO Äá»</button>
        </div>
    </div>

    <div id="tab-daubai" style="display:none">
        <div class="header">
            <h2 id="daubai-title" style="margin:0; font-size: 1.1rem; color:var(--s)">Sá»” Äáº¦U BÃ€I ÄIá»†N Tá»¬</h2>
        </div>
        <div class="card">
            <h3>ğŸ“ GHI TIáº¾T Há»ŒC / VI PHáº M</h3>
            <div id="list-daubai" style="max-height:300px; overflow-y:auto; border:1px solid #ddd; border-radius:10px"></div>
            <button class="btn btn-save" onclick="saveData('daubai')" style="background:var(--s)">ğŸ’¾ Cáº¬P NHáº¬T VÃ€O Sá»”</button>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“œ CHI TIáº¾T ÄÃƒ GHI (Lá»šP ÄANG CHá»ŒN)</h3>
        <button class="btn btn-copy" onclick="copyData()">ğŸ“‹ SAO CHÃ‰P Báº¢NG Dá»® LIá»†U</button>
        <div style="overflow-x:auto">
            <table id="log-table">
                <thead>
                    <tr><th>Ná»™i dung</th><th>Biá»ƒu</th><th>Há»c sinh</th><th>Tá»•ng</th><th>XÃ³a</th></tr>
                </thead>
                <tbody id="log-body"></tbody>
            </table>
        </div>
        <button class="btn btn-logout" onclick="location.reload()">ğŸ”’ ÄÄ‚NG XUáº¤T</button>
    </div>
</div>

<script>
    const PIN_SAODO = "1234";
    const LOP_PINS = { "6A":"6001", "6B":"6002", "7A":"7001", "8A":"8001", "9A":"9001" };
    const LOP_LIST = Object.keys(LOP_PINS);

    const CRITERIA = [
        { g: "TIáº¾T Há»ŒC", i: [{n:"Tiáº¿t há»c loáº¡i A",d:10}, {n:"Tiáº¿t há»c loáº¡i B",d:5}, {n:"Tiáº¿t há»c loáº¡i C",d:-5}, {n:"Tiáº¿t há»c loáº¡i D",d:-10}] },
        { g: "TÃC PHONG", i: [{n:"KhÃ´ng Ä‘eo khÄƒn quÃ ng",d:-5}, {n:"KhÃ´ng bá» Ã¡o vÃ o quáº§n",d:-5}, {n:"Äá»“ng phá»¥c sai",d:-5}] },
        { g: "CHUYÃŠN Cáº¦N", i: [{n:"Äi trá»…",d:-2}, {n:"Váº¯ng khÃ´ng phÃ©p",d:-5}, {n:"Trá»‘n tiáº¿t",d:-10}] },
        { g: "Há»ŒC Táº¬P", i: [{n:"Äiá»ƒm 10",d:10}, {n:"Äiá»ƒm 8,9",d:9}, {n:"Äiá»ƒm kÃ©m (0-3)",d:-10}] }
    ];

    let userRole = ""; // "SAODO" hoáº·c tÃªn lá»›p
    let selectedClass = ""; 
    let db = JSON.parse(localStorage.getItem('PHUOC_AN_FULL_DB')) || {};

    function handleAuth() {
        const pin = document.getElementById('pin-input').value;
        if(pin === PIN_SAODO) {
            userRole = "SAODO";
            loginSuccess();
        } else {
            for (let lop in LOP_PINS) {
                if(LOP_PINS[lop] === pin) {
                    userRole = lop;
                    selectedClass = lop;
                    loginSuccess();
                    return;
                }
            }
        }
    }

    function loginSuccess() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('main-nav').style.display = 'flex';
        document.getElementById('app').style.display = 'block';
        initDB();
        renderBXH();
        buildList('saodo');
        buildList('daubai');
        if(userRole !== "SAODO") {
            document.getElementById('menu-saodo').style.display = 'none';
            switchTab('daubai');
        }
    }

    function initDB() {
        LOP_LIST.forEach(l => { if(!db[l]) db[l] = { score: 100, logs: [] }; });
    }

    function buildList(type) {
        const container = document.getElementById('list-' + type);
        container.innerHTML = "";
        CRITERIA.forEach(group => {
            container.innerHTML += `<div style="background:#eee;padding:5px;font-size:0.7rem;font-weight:bold">${group.g}</div>`;
            group.i.forEach(item => {
                const id = type + Math.random().toString(36).substr(2, 5);
                container.innerHTML += `
                    <div class="loi-item" id="item-${id}">
                        <div class="loi-row" onclick="toggleItem('${id}')">
                            <span>${item.n}</span>
                            <span class="${item.d<0?'minus':'plus'}"><b>${item.d>0?'+':''}${item.d}</b></span>
                            <input type="checkbox" id="cb-${id}" data-n="${item.n}" data-d="${item.d}" style="display:none">
                        </div>
                        <input type="text" class="input-name" id="name-${id}" placeholder="TÃªn HS hoáº·c x2, x3...">
                    </div>`;
            });
        });
    }

    function toggleItem(id) {
        const cb = document.getElementById('cb-'+id);
        const item = document.getElementById('item-'+id);
        cb.checked = !cb.checked;
        item.classList.toggle('active', cb.checked);
        if(cb.checked) document.getElementById('name-'+id).focus();
    }

    function switchTab(tab) {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById('menu-' + tab).classList.add('active');
        document.getElementById('tab-saodo').style.display = tab === 'saodo' ? 'block' : 'none';
        document.getElementById('tab-daubai').style.display = tab === 'daubai' ? 'block' : 'none';
        if(tab === 'daubai') {
            document.getElementById('daubai-title').innerText = "Sá»” Äáº¦U BÃ€I Lá»šP " + selectedClass;
            renderLogs();
        }
    }

    function selectClass(lop) {
        if(userRole !== "SAODO") return;
        selectedClass = lop;
        document.querySelectorAll('.lop-row').forEach(r => r.classList.remove('active-lop'));
        document.getElementById('row-'+lop).classList.add('active-lop');
        document.getElementById('saodo-input-area').style.display = 'block';
        document.getElementById('saodo-lop-label').innerText = "CHáº¤M ÄIá»‚M Lá»šP " + lop;
        renderLogs();
    }

    function saveData(type) {
        if(!selectedClass) return alert("Vui lÃ²ng chá»n lá»›p!");
        const selected = document.querySelectorAll(`#list-${type} input[type="checkbox"]:checked`);
        selected.forEach(cb => {
            const id = cb.id.replace('cb-', '');
            const name = document.getElementById('name-'+id).value || "Táº­p thá»ƒ";
            const points = parseInt(cb.dataset.d);
            let times = 1;
            const match = name.match(/x(\d+)/);
            if(match) times = parseInt(match[1]);

            db[selectedClass].logs.unshift({
                id: Date.now() + Math.random(),
                content: cb.dataset.n + ` (${type === 'saodo' ? 'Sao Ä‘á»' : 'SÄB'})`,
                base: points,
                who: name,
                total: points * times
            });
            db[selectedClass].score += (points * times);
            
            // Reset
            cb.checked = false;
            document.getElementById('item-'+id).classList.remove('active');
            document.getElementById('name-'+id).value = "";
        });
        localStorage.setItem('PHUOC_AN_FULL_DB', JSON.stringify(db));
        renderBXH(); renderLogs();
        alert("ÄÃ£ lÆ°u!");
    }

    function renderBXH() {
        const sorted = [...LOP_LIST].sort((a,b) => db[b].score - db[a].score);
        const body = document.getElementById('bxh-body');
        body.innerHTML = "";
        sorted.forEach((l, i) => {
            body.innerHTML += `<tr class="lop-row" id="row-${l}" onclick="selectClass('${l}')">
                <td><span class="rank ${i<3?'rank-1':''}">${i+1}</span></td>
                <td>Lá»›p ${l}</td>
                <td style="color:${db[l].score<100?'red':'green'}">${db[l].score}</td>
            </tr>`;
        });
    }

    function renderLogs() {
        const body = document.getElementById('log-body');
        body.innerHTML = "";
        if(!selectedClass) return;
        db[selectedClass].logs.forEach(log => {
            body.innerHTML += `<tr>
                <td>${log.content}</td>
                <td>${log.base}</td>
                <td>${log.who}</td>
                <td class="${log.total<0?'minus':'plus'}">${log.total}</td>
                <td><button onclick="deleteLog(${log.id})" style="color:red;border:none;background:none">âœ•</button></td>
            </tr>`;
        });
    }

    function deleteLog(id) {
        if(!confirm("XÃ³a dÃ²ng nÃ y?")) return;
        const idx = db[selectedClass].logs.findIndex(l => l.id === id);
        db[selectedClass].score -= db[selectedClass].logs[idx].total;
        db[selectedClass].logs.splice(idx, 1);
        localStorage.setItem('PHUOC_AN_FULL_DB', JSON.stringify(db));
        renderBXH(); renderLogs();
    }

    function copyData() {
        const table = document.getElementById('log-table');
        const range = document.createRange();
        range.selectNode(table);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        document.execCommand('copy');
        alert("ÄÃ£ copy dá»¯ liá»‡u lá»›p " + selectedClass);
    }

    function filterLoi(type) {
        let key = document.getElementById('search-'+type).value.toLowerCase();
        document.querySelectorAll(`#list-${type} .loi-item`).forEach(it => {
            it.style.display = it.innerText.toLowerCase().includes(key) ? 'flex' : 'none';
        });
    }
</script>
</body>
</html>
