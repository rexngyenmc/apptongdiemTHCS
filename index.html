<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WEB SAO ƒê·ªé PH∆Ø·ªöC AN</title>
    <style>
        :root { --p: #0056b3; --s: #2e7d32; --a: #d32f2f; --bg: #f8f9fa; --gold: #ffd700; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--p); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; }
        .pin-input { width: 160px; padding: 15px; border-radius: 15px; border: none; font-size: 2rem; text-align: center; letter-spacing: 5px; font-weight: bold; margin: 20px 0; color: var(--p); outline: none; }
        .header { background: white; padding: 15px; border-radius: 15px; text-align: center; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 5px solid var(--p); }
        .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f1f1f1; font-size: 0.7rem; padding: 8px; border: 1px solid #ddd; }
        td { padding: 10px 5px; text-align: center; border: 1px solid #ddd; font-weight: bold; font-size: 0.8rem; }
        .rank { width: 25px; height: 25px; line-height: 25px; display: inline-block; border-radius: 50%; background: #eee; font-size: 0.7rem; }
        .rank-1 { background: var(--gold); }
        .input-group { margin-bottom: 15px; }
        .input-label { font-size: 0.8rem; font-weight: bold; color: var(--p); display: block; margin-bottom: 5px; }
        .input-box { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 1rem; outline: none; }
        .scroll-form { max-height: 350px; overflow-y: auto; border: 1px solid #eee; border-radius: 10px; padding: 5px; background: #fff; }
        .group-title { background: #e9ecef; padding: 6px; font-weight: bold; font-size: 0.75rem; margin: 10px 0 5px 0; border-left: 4px solid var(--p); }
        .loi-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f1f1f1; cursor: pointer; }
        .score-tag { font-weight: bold; font-size: 0.85rem; width: 50px; text-align: right; }
        .minus { color: var(--a); } .plus { color: var(--s); }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1rem; }
        .btn-apply { background: var(--p); color: white; }
        .btn-zalo { background: #0068ff; color: white; }
        .btn-copy { background: #28a745; color: white; margin-bottom: 10px; }
        .btn-reset { background: #fff; color: var(--a); border: 1px solid var(--a); margin-top: 20px; font-size: 0.7rem; }
        .btn-del { color: red; border: none; background: none; font-weight: bold; cursor: pointer; }
        .active-lop { background: #e3f2fd !important; }
    </style>
</head>
<body>

<div id="login-screen">
    <h2 style="margin:0">üîë M·∫¨T M√É SAO ƒê·ªé</h2>
    <input type="password" id="pin-input" class="pin-input" placeholder="****" maxlength="4" oninput="checkPin()">
</div>

<div id="main-content">
    <div class="header">
        <h1 style="font-size: 1rem; margin:0; color:var(--p)">LI√äN ƒê·ªòI TH & THCS PH∆Ø·ªöC AN</h1>
    </div>

    <div class="container">
        <div class="card">
            <h3 style="margin-top:0; font-size:0.9rem">üèÜ B·∫¢NG X·∫æP H·∫†NG</h3>
            <table>
                <thead><tr><th>H·∫°ng</th><th>L·ªõp</th><th>ƒêi·ªÉm</th></tr></thead>
                <tbody id="bxh-body"></tbody>
            </table>
            <button class="btn btn-zalo" onclick="xuatZalo()">üîµ Copy b√°o c√°o Zalo</button>
        </div>

        <div class="card" id="input-area" style="display:none;">
            <h3 id="current-lop-label" style="color:var(--p); text-align:center; margin-top:0"></h3>
            
            <div class="input-group">
                <span class="input-label">üë§ C√Å NH√ÇN/T·∫¨P TH·ªÇ (VD: Nguy√™n x2, B·∫£o...):</span>
                <input type="text" id="hs-names" class="input-box" placeholder="V√≠ d·ª•: Ho√†ng, H√†, √Çn...">
            </div>

            <div class="input-group">
                <span class="input-label">üîç T√åM KI·∫æM L·ªñI:</span>
                <input type="text" id="search-loi" class="input-box" placeholder="G√µ t√™n l·ªói..." onkeyup="filterLoi()">
            </div>

            <div class="scroll-form" id="error-list">
                <div class="group-title">T√ÅC PHONG - ƒê·ªíNG PH·ª§C (-5ƒë)</div>
                <div class="loi-item" onclick="toggleLoi('l1')"><input type="checkbox" id="l1" data-d="-5" data-n="Kh√¥ng ƒëeo KhƒÉn qu√†ng/Huy hi·ªáu"> <span>Kh√¥ng ƒëeo KhƒÉn qu√†ng/Huy hi·ªáu</span> <div class="score-tag minus">-5</div></div>
                <div class="loi-item" onclick="toggleLoi('l2')"><input type="checkbox" id="l2" data-d="-5" data-n="Kh√¥ng b·ªè √°o v√†o qu·∫ßn"> <span>Kh√¥ng b·ªè √°o v√†o qu·∫ßn</span> <div class="score-tag minus">-5</div></div>
                <div class="group-title">H·ªåC T·∫¨P & TI·∫æT H·ªåC</div>
                <div class="loi-item" onclick="toggleLoi('l28')"><input type="checkbox" id="l28" data-d="10" data-n="ƒêi·ªÉm s·ªë: 10"> <span>ƒê·∫°t ƒëi·ªÉm 10</span> <div class="score-tag plus">+10</div></div>
            </div>

            <button class="btn btn-apply" onclick="luuDuLieu()">L∆ØU V√ÄO L·ªäCH S·ª¨</button>

            <h3 style="font-size:0.8rem; margin-top:20px;">üìú L·ªäCH S·ª¨ CH·∫§M (L·ªöP ƒêANG CH·ªåN)</h3>
            <button class="btn btn-copy" onclick="copyTableLS()">üìã Sao ch√©p b·∫£ng LS (C√≥ vi·ªÅn)</button>
            <table class="ls-table" id="table-to-copy">
                <thead>
                    <tr>
                        <th>Vi·ªác l√†m t·ªët/kh√¥ng t·ªët</th>
                        <th>Bi·ªÉu ƒëi·ªÉm</th>
                        <th>C√° nh√¢n/T·∫≠p th·ªÉ</th>
                        <th>S·ªë l·∫ßn</th>
                        <th>ƒêi·ªÉm</th>
                        <th>X√≥a</th>
                    </tr>
                </thead>
                <tbody id="ls-body"></tbody>
            </table>
        </div>

        <button class="btn btn-reset" onclick="resetTuan()">üîÑ RESET TU·∫¶N M·ªöI</button>
    </div>
</div>

<script>
    const PIN = "1234";
    const LOP_LIST = ['6A','6B','6C','7A','7B','7C','8A','8B','8C','9A','9B'];
    let db = JSON.parse(localStorage.getItem('PHUOC_AN_DB')) || {};
    let curLop = "";

    LOP_LIST.forEach(l => { if(!db[l]) db[l] = { total: 100, logs: [] }; });

    function checkPin() {
        if(document.getElementById('pin-input').value === PIN) {
            document.getElementById('login-screen').style.display = 'none';
            renderBXH();
        }
    }

    function renderBXH() {
        const sorted = [...LOP_LIST].sort((a,b) => db[b].total - db[a].total);
        const body = document.getElementById('bxh-body');
        body.innerHTML = '';
        sorted.forEach((l, i) => {
            body.innerHTML += `<tr class="lop-row" id="row-${l}" onclick="chonLop('${l}')">
                <td><span class="rank ${i<3?'rank-1':''}">${i+1}</span></td>
                <td>L·ªõp ${l}</td>
                <td style="color:${db[l].total<100?'red':'green'}">${db[l].total}</td>
            </tr>`;
        });
        localStorage.setItem('PHUOC_AN_DB', JSON.stringify(db));
    }

    function chonLop(l) {
        curLop = l;
        document.querySelectorAll('.lop-row').forEach(r => r.classList.remove('active-lop'));
        document.getElementById(`row-${l}`).classList.add('active-lop');
        document.getElementById('input-area').style.display = 'block';
        document.getElementById('current-lop-label').innerText = `ƒêANG CH·∫§M: L·ªöP ${l}`;
        renderLS();
    }

    function toggleLoi(id) { document.getElementById(id).checked = !document.getElementById(id).checked; }

    function filterLoi() {
        let key = document.getElementById('search-loi').value.toLowerCase();
        document.querySelectorAll('.loi-item').forEach(it => {
            it.style.display = it.innerText.toLowerCase().includes(key) ? 'flex' : 'none';
        });
    }

    function luuDuLieu() {
        if(!curLop) return;
        const nameInput = document.getElementById('hs-names').value.trim() || "T·∫≠p th·ªÉ";
        const selected = document.querySelectorAll('#error-list input:checked');
        if(selected.length === 0) return alert("Ch∆∞a ch·ªçn m·ª•c n√†o!");

        // X·ª≠ l√Ω s·ªë l·∫ßn th√¥ng minh (H·ªó tr·ª£ ƒë·ªãnh d·∫°ng T√™n xS·ªë_l·∫ßn)
        const namesArray = nameInput.split(',').filter(n => n.trim() !== "");
        let soLan = 0;
        if (namesArray.length === 0) { soLan = 1; } 
        else {
            namesArray.forEach(item => {
                let match = item.toLowerCase().match(/x\s*(\d+)/);
                soLan += match ? parseInt(match[1]) : 1;
            });
        }

        selected.forEach(s => {
            let diemGoc = parseInt(s.dataset.d);
            let tongDiemRow = diemGoc * soLan;
            db[curLop].logs.unshift({
                id: Date.now() + Math.random(),
                name: nameInput,
                vi·ªác: s.dataset.n,
                bi·ªÉu: (diemGoc > 0 ? "+" : "") + diemGoc,
                l·∫ßn: soLan,
                t·ªïng: (tongDiemRow > 0 ? "+" : "") + tongDiemRow
            });
            db[curLop].total += tongDiemRow;
            s.checked = false;
        });
        document.getElementById('hs-names').value = "";
        renderBXH(); renderLS();
    }

    function renderLS() {
        const body = document.getElementById('ls-body');
        body.innerHTML = '';
        db[curLop].logs.forEach(log => {
            body.innerHTML += `<tr>
                <td>${log.vi·ªác}</td>
                <td class="${parseInt(log.bi·ªÉu)<0?'minus':'plus'}">${log.bi·ªÉu}</td>
                <td>${log.name}</td>
                <td>${log.l·∫ßn}</td>
                <td class="${parseInt(log.t·ªïng)<0?'minus':'plus'}">${log.t·ªïng}</td>
                <td><button class="btn-del" onclick="xoaLog('${log.id}')">‚úï</button></td>
            </tr>`;
        });
    }

    function copyTableLS() {
        const table = document.getElementById("table-to-copy");
        if (!table || table.rows.length <= 1) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu!");
        const tempDiv = document.createElement("div");
        const tableClone = table.cloneNode(true);
        for (let row of tableClone.rows) { row.deleteCell(-1); } // X√≥a c·ªôt "X√≥a"
        
        // ƒê·ªãnh d·∫°ng khung vi·ªÅn cho b·∫£ng khi sao ch√©p
        tableClone.style.borderCollapse = "collapse";
        tableClone.style.width = "100%";
        tableClone.querySelectorAll("th, td").forEach(cell => {
            cell.style.border = "1px solid black";
            cell.style.padding = "5px";
            cell.style.textAlign = "center";
        });
        tempDiv.appendChild(tableClone);
        document.body.appendChild(tempDiv);
        const range = document.createRange();
        range.selectNode(tempDiv);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        document.execCommand('copy');
        selection.removeAllRanges();
        document.body.removeChild(tempDiv);
        alert("ƒê√£ sao ch√©p b·∫£ng c√≥ vi·ªÅn!");
    }

    function xuatZalo() {
        let txt = "üìä B√ÅO C√ÅO THI ƒêUA PH∆Ø·ªöC AN\n";
        [...LOP_LIST].sort((a,b) => db[b].total - db[a].total).forEach((l, i) => {
            txt += `${i+1}. L·ªõp ${l}: ${db[l].total}ƒë\n`;
        });
        navigator.clipboard.writeText(txt).then(() => alert("ƒê√£ copy b√°o c√°o!"));
    }

    function xoaLog(id) {
        if(!confirm("X√≥a d√≤ng n√†y?")) return;
        const index = db[curLop].logs.findIndex(x => x.id == id);
        if(index > -1) {
            db[curLop].total -= parseInt(db[curLop].logs[index].t·ªïng);
            db[curLop].logs.splice(index, 1);
            renderBXH(); renderLS();
        }
    }

    function resetTuan() { if(confirm("X√≥a h·∫øt d·ªØ li·ªáu tu·∫ßn c≈©?")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>
