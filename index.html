<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Thi Đua Lớp</title>
<style>
body{
  font-family: Arial;
  background:#0f172a;
  color:white;
  padding:20px;
}
table{
  width:100%;
  border-collapse: collapse;
  margin-bottom:20px;
}
th,td{
  border:1px solid #334155;
  padding:8px;
  text-align:center;
}
button{
  padding:6px 12px;
  margin:5px 0;
  cursor:pointer;
}
.box{
  background:#1e293b;
  padding:10px;
  margin-top:10px;
}
h3{
  margin-top:30px;
}
hr{
  border:1px solid #334155;
}
</style>
</head>
<body>

<h2>BẢNG XẾP HẠNG</h2>
<table id="rankTable">
<thead>
<tr>
<th>Lớp</th>
<th>Điểm</th>
<th>Chấm</th>
</tr>
</thead>
<tbody></tbody>
</table>

<button onclick="saveWeek()">Chốt tuần</button>

<h3>Lịch sử tuần</h3>
<div id="weekHistory" class="box"></div>

<h3>Lịch sử tháng</h3>
<div id="monthHistory" class="box"></div>

<h3>Lịch sử năm</h3>
<div id="yearHistory" class="box"></div>

<h3>Lịch sử chấm điểm</h3>
<div id="historyBox" class="box"></div>

<script>
const LOPS=["6A","6B","6C","7A","7B","8A","8B","9A"];

const LOIS=[
 {n:"Không đồng phục",d:-5},
 {n:"Đi trễ",d:-2},
 {n:"Nói chuyện",d:-5},
 {n:"Điểm 10",d:10},
 {n:"Tham gia phong trào",d:10}
];

let DB=JSON.parse(localStorage.getItem("THIDUA_DB"))||{};

LOPS.forEach(l=>{
 if(!DB[l]) DB[l]={diem:0};
});

if(!DB.historyLogs) DB.historyLogs=[];
if(!DB.weekHistory) DB.weekHistory=[];
if(!DB.monthHistory) DB.monthHistory=[];
if(!DB.yearHistory) DB.yearHistory=[];

function saveDB(){
 localStorage.setItem("THIDUA_DB",JSON.stringify(DB));
}

function renderTable(){
 const tbody=document.querySelector("#rankTable tbody");
 tbody.innerHTML="";
 
 let arr=LOPS.map(l=>({lop:l,diem:DB[l].diem}));
 arr.sort((a,b)=>b.diem-a.diem);
 
 arr.forEach(l=>{
   let tr=document.createElement("tr");
   tr.innerHTML=`
   <td>${l.lop}</td>
   <td>${l.diem}</td>
   <td><button onclick="chamDiem('${l.lop}')">+</button></td>
   `;
   tbody.appendChild(tr);
 });
}

function chamDiem(lop){
 let ten=prompt("Nhập tên người:");
 if(!ten) return;
 
 let text="Chọn lỗi:\n";
 LOIS.forEach((l,i)=>{
   text+=`${i+1}. ${l.n} (${l.d})\n`;
 });
 
 let chon=prompt(text);
 if(!chon) return;
 
 let loi=LOIS[chon-1];
 if(!loi) return;
 
 DB[lop].diem+=loi.d;
 
 DB.historyLogs.unshift({
   time:new Date().toLocaleString(),
   lop,
   ten,
   loi:loi.n,
   diem:loi.d
 });
 
 if(DB.historyLogs.length>20){
   DB.historyLogs.pop();
 }
 
 saveDB();
 renderTable();
 renderHistory();
}

function renderHistory(){
 const box=document.getElementById("historyBox");
 box.innerHTML="";
 DB.historyLogs.forEach(log=>{
   box.innerHTML+=`
   <div>${log.time} - ${log.lop} - ${log.ten} - ${log.loi} (${log.diem})</div>
   `;
 });
}

function saveWeek(){
 let weekData={
   time:new Date().toLocaleDateString(),
   data:{}
 };
 
 LOPS.forEach(l=>{
   weekData.data[l]=DB[l].diem;
   DB[l].diem=0;
 });
 
 DB.weekHistory.push(weekData);
 
 // 4 tuần = 1 tháng
 if(DB.weekHistory.length%4===0){
   let monthData={time:new Date().toLocaleDateString(),data:{}};
   LOPS.forEach(l=>{
     monthData.data[l]=0;
     for(let i=DB.weekHistory.length-4;i<DB.weekHistory.length;i++){
       monthData.data[l]+=DB.weekHistory[i].data[l];
     }
   });
   DB.monthHistory.push(monthData);
   
   // 12 tháng = 1 năm
   if(DB.monthHistory.length%12===0){
     let yearData={time:new Date().toLocaleDateString(),data:{}};
     LOPS.forEach(l=>{
       yearData.data[l]=0;
       for(let i=DB.monthHistory.length-12;i<DB.monthHistory.length;i++){
         yearData.data[l]+=DB.monthHistory[i].data[l];
       }
     });
     DB.yearHistory.push(yearData);
   }
 }
 
 saveDB();
 renderTable();
 renderWeekHistory();
 renderMonthHistory();
 renderYearHistory();
}

function renderWeekHistory(){
 const box=document.getElementById("weekHistory");
 box.innerHTML="";
 DB.weekHistory.forEach((w,i)=>{
   box.innerHTML+=`<h4>Tuần ${i+1}</h4>`;
   LOPS.forEach(l=>{
     box.innerHTML+=`<div>${l}: ${w.data[l]}</div>`;
   });
   box.innerHTML+="<hr>";
 });
}

function renderMonthHistory(){
 const box=document.getElementById("monthHistory");
 box.innerHTML="";
 DB.monthHistory.forEach((m,i)=>{
   box.innerHTML+=`<h4>Tháng ${i+1}</h4>`;
   LOPS.forEach(l=>{
     box.innerHTML+=`<div>${l}: ${m.data[l]}</div>`;
   });
   box.innerHTML+="<hr>";
 });
}

function renderYearHistory(){
 const box=document.getElementById("yearHistory");
 box.innerHTML="";
 DB.yearHistory.forEach((y,i)=>{
   box.innerHTML+=`<h4>Năm ${i+1}</h4>`;
   LOPS.forEach(l=>{
     box.innerHTML+=`<div>${l}: ${y.data[l]}</div>`;
   });
   box.innerHTML+="<hr>";
 });
}

renderTable();
renderHistory();
renderWeekHistory();
renderMonthHistory();
renderYearHistory();
</script>

</body>
</html>
